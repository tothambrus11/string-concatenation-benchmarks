# Swift String Benchmarking Suite

This project presents benchmarks for string concatenation approaches and the benefits of avoiding temporary allocations.

## Benchmarks

### 1. LazyMap+Joined

Uses functional programming with lazy evaluation:

- `arr.lazy.map { ... }` to transform elements
- `.joined(separator: "\n")` to concatenate
- String interpolation for formatting

```swift
let str = "BEGINNING \(arr.lazy.map { p in "    \(p) -> \(p * p)" }.joined(separator: "\n")) END"
```

### 2. ManualConcatenation

Uses imperative programming with explicit loops:

- Manual `for` loop iteration
- String concatenation with `+=` operator, making sure we only grow the single string storage
- `.description` for conversion to string

```swift
var str = "BEGINNING "
for i in 0..<arr.count {
    let p = arr[i]
    str += "    "
    str += p.description
    str += " -> "
    str += (p * p).description
    if i != arr.count - 1 {
        str += "\n"
    }
}
str += " END"
```

## Metrics Collected

- Malloc (large, small, total)
- CPU time
- Wall clock time

## Results Summary

I'll create a comparison table with the median values from each benchmark.

| Benchmark                                                       | Wall Clock Time (ms) | Small Malloc | Large Malloc | Total Malloc |
| --------------------------------------------------------------- | -------------------- | ------------ | ------------ | ------------ |
| LazyMap + Joined                                                | 266                  | 2000K        | 6            | 2000K        |
| Piecewise Manual Concatenation                                  | 194                  | 25           | 12           | 37           |
| Manual Concatenation + String Interpolation                     | 176                  | 1000K        | 12           | 1000K        |
| Manual Concatenation + Temporaries Without String Interpolation | 223                  | 1000K        | 12           | 1000K        |

```
LazyMap + Joined
╒══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                   │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Malloc (large) *         │         6 │         6 │         6 │         6 │         6 │         6 │         6 │        38 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (small) (K) *     │      2000 │      2000 │      2000 │      2000 │      2000 │      2000 │      2000 │        38 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (total) (K) *     │      2000 │      2000 │      2000 │      2000 │      2000 │      2000 │      2000 │        38 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ms) *  │       260 │       270 │       280 │       280 │       290 │       300 │       300 │        38 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (wall clock) (ms) * │       248 │       263 │       266 │       269 │       273 │       282 │       282 │        38 │
╘══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Piecewise Manual Concatenation
╒══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                   │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Malloc (large) *         │        12 │        12 │        12 │        12 │        12 │        12 │        12 │        52 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (small) *         │        25 │        25 │        25 │        25 │        25 │        25 │        25 │        52 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (total) *         │        37 │        37 │        37 │        37 │        37 │        37 │        37 │        52 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ms) *  │       190 │       200 │       200 │       210 │       210 │       220 │       220 │        52 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (wall clock) (ms) * │       188 │       192 │       194 │       197 │       200 │       205 │       205 │        52 │
╘══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Manual Concatenation + String Interpolation
╒══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                   │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Malloc (large) *         │        12 │        12 │        12 │        12 │        12 │        12 │        12 │        57 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (small) (K) *     │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │        57 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (total) (K) *     │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │        57 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ms) *  │       170 │       180 │       180 │       190 │       190 │       200 │       200 │        57 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (wall clock) (ms) * │       169 │       174 │       176 │       177 │       180 │       183 │       183 │        57 │
╘══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛

Manual Concatenation + Temporaries Without string interpolation
╒══════════════════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╕
│ Metric                   │        p0 │       p25 │       p50 │       p75 │       p90 │       p99 │      p100 │   Samples │
╞══════════════════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╡
│ Malloc (large) *         │        12 │        12 │        12 │        12 │        12 │        12 │        12 │        45 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (small) (K) *     │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │        45 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Malloc (total) (K) *     │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │      1000 │        45 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (total CPU) (ms) *  │       220 │       230 │       230 │       240 │       240 │       270 │       270 │        45 │
├──────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┤
│ Time (wall clock) (ms) * │       217 │       221 │       223 │       225 │       229 │       263 │       263 │        45 │
╘══════════════════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╛
```

## Prerequisites

Install jemalloc development library:

```bash
# Ubuntu/Debian
sudo apt-get install libjemalloc-dev

# macOS
brew install jemalloc
```

## Usage

### Run all benchmarks:

```bash
swift package --disable-sandbox benchmark
```
